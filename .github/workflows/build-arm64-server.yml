name: Build DDNet Server ARM64

on:
  workflow_dispatch:
  push:
    branches: [master, main]
    paths:
      - '.github/workflows/build-arm64-server.yml'

jobs:
  build-arm64:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Build in Debian 12 container
        run: |
          docker run --rm -v ${{ github.workspace }}:/src -w /src arm64v8/debian:12 bash -c '
            apt-get update && apt-get install -y \
              build-essential \
              cmake \
              python3 \
              libcurl4-openssl-dev \
              libssl-dev \
              libsqlite3-dev \
              zlib1g-dev \
              libpng-dev \
              curl \
              pkg-config \
              ca-certificates

            # Install Rust
            curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            export PATH="/root/.cargo/bin:$PATH"

            mkdir -p build-arm64
            cd build-arm64
            cmake .. \
              -DCLIENT=OFF \
              -DHEADLESS_CLIENT=OFF \
              -DTOOLS=OFF \
              -DCMAKE_BUILD_TYPE=Release
            make -j$(nproc) game-server
          '

      - name: Check binary
        run: |
          file build-arm64/DDNet-Server
          ls -la build-arm64/DDNet-Server

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DDNet-Server-arm64-debian12
          path: build-arm64/DDNet-Server
          retention-days: 30
